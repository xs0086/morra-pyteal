"use strict";var e=require("@walletconnect/client"),t=require("algosdk"),n=require("bowser");function a(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=a(e),r=a(t),l=a(n);function s(e,t,n,a){return new(n||(n=Promise))((function(o,r){function l(e){try{i(a.next(e))}catch(e){r(e)}}function s(e){try{i(a.throw(e))}catch(e){r(e)}}function i(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(l,s)}i((a=a.apply(e,t||[])).next())}))}class i extends Error{constructor(e,t,...n){super(...n),Error.captureStackTrace&&Error.captureStackTrace(this,i),this.name="PeraWalletConnectError",this.data=e,this.message=t}}const d=new class{constructor(e){this.listener=void 0,this.channel=e.channel}setupListener({onReceiveMessage:e}){this.close(),this.listener=t=>{if("object"==typeof t.data)try{t.data.channel===this.channel&&e(t)}catch(e){console.error(e)}},window.addEventListener("message",this.listener)}sendMessage({message:e,targetWindow:t,origin:n,timeout:a=1e3}){setTimeout((()=>{const a={channel:this.channel,message:e};t.postMessage(a,{targetOrigin:n||"*"})}),a)}close(){this.listener&&(window.removeEventListener("message",this.listener),this.listener=void 0)}}({channel:"pera-web-wallet"});function c(){const e=document.querySelector('meta[name="name"]'),t=document.querySelector('meta[name="description"]');let{title:n}=document,a="";return e instanceof HTMLMetaElement&&(n=e.content),t instanceof HTMLMetaElement&&(a=t.content),{title:n,description:a,url:window.location.origin,favicon:u()[0]}}function u(){const e=document.getElementsByTagName("link"),t=[];for(let n=0;n<e.length;n++){const a=e[n],o=a.getAttribute("rel");if(o&&o.toLowerCase().indexOf("icon")>-1){const e=a.getAttribute("href");if(e&&-1===e.toLowerCase().indexOf("https:")&&-1===e.toLowerCase().indexOf("http:")&&0!==e.indexOf("//")){let n=`${window.location.protocol}//${window.location.host}`;if(0===e.indexOf("/"))n+=e;else{const t=window.location.pathname.split("/");t.pop();n+=`${t.join("/")}/${e}`}t.push(n)}else if(0===(null==e?void 0:e.indexOf("//"))){const n=window.location.protocol+e;t.push(n)}else e&&t.push(e)}}return t}function p(e){return new Promise(((t,n)=>{try{const a=window.open(e,"_blank");let o=0;const r=setInterval((()=>{if(o+=1,50===o)return clearInterval(r),void n(new i({type:"MESSAGE_NOT_RECEIVED"},"Couldn't open Pera Wallet, please try again."));a&&(!0===a.closed&&(clearInterval(r),n(new i({type:"OPERATION_CANCELLED"},"Operation cancelled by user"))),d.sendMessage({message:{type:"TAB_OPEN"},origin:e,targetWindow:a}))}),700);d.setupListener({onReceiveMessage:e=>{"TAB_OPEN_RECEIVED"===e.data.message.type&&(clearInterval(r),t(a))}})}catch(e){n(e)}}))}function w(e){const t=document.createElement("div");return t.setAttribute("id",e),document.body.appendChild(t),t}function g(){const e=w("pera-wallet-sign-txn-modal-wrapper");e.innerHTML="<pera-wallet-sign-txn-modal></pera-wallet-sign-txn-modal>";const t=e.querySelector("pera-wallet-sign-txn-modal");return t?(n=t,a="pera-wallet-sign-txn-modal__body__content",new Promise((e=>{var t;const o=null===(t=n.shadowRoot)||void 0===t?void 0:t.querySelector(`.${a}`);if(o)return e(o);const r=new MutationObserver((()=>{o&&(e(o),r.disconnect())}));r.observe(n,{childList:!0,subtree:!0})}))):Promise.reject();var n,a}function m(e){h("pera-wallet-sign-txn-modal-wrapper"),e&&e(new i({type:"SIGN_TXN_CANCELLED"},"Transaction sign is cancelled"))}function h(e){const t=document.getElementById(e);t&&t.remove()}const v="PeraWallet.Wallet",N="walletconnect";function E(){return"undefined"==typeof localStorage?void 0:localStorage}function C(e,t){var n;null===(n=E())||void 0===n||n.setItem(v,JSON.stringify({type:t||"pera-wallet",accounts:e,selectedAccount:e[0]}))}function f(){var e;const t=null===(e=E())||void 0===e?void 0:e.getItem(v);return t?JSON.parse(t):null}function T(){return new Promise(((e,t)=>{var n,a;try{null===(n=E())||void 0===n||n.removeItem(N),null===(a=E())||void 0===a||a.removeItem(v),e(void 0)}catch(e){t(e)}}))}function y(e){const t=e.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}function _(){return function(e,t={}){return fetch(e,t).then((e=>e.json())).then((e=>e))}("https://wc.perawallet.app/config.json",{cache:"no-store"})}function I(){return s(this,void 0,void 0,(function*(){let e={bridgeURL:"",webWalletURL:"",isWebWalletAvailable:!1,shouldDisplayNewBadge:!1,shouldUseSound:!0,silent:!1};try{const t=yield _();void 0!==t.web_wallet&&t.web_wallet_url&&(e.isWebWalletAvailable=t.web_wallet),void 0!==t.display_new_badge&&(e.shouldDisplayNewBadge=t.display_new_badge),void 0!==t.use_sound&&(e.shouldUseSound=t.use_sound),void 0!==t.silent&&(e.silent=t.silent),e=Object.assign(Object.assign({},e),{bridgeURL:y(t.servers||[])[0]||"",webWalletURL:t.web_wallet_url||""})}catch(e){console.log(e)}return e}))}function A(e){return Uint8Array.from(window.atob(e),(e=>e.charCodeAt(0)))}function S(){return"undefined"!=typeof navigator}function b(){return S()&&/Android/i.test(navigator.userAgent)}function O(){return S()&&/iPhone|iPad|iPod/i.test(navigator.userAgent)}function L(){return S()&&/iPhone|iPod|Android/i.test(navigator.userAgent)}function W(){if(!S())return null;const{userAgent:e}=navigator;let t;return t=e.match(/DuckDuckGo/i)?"DuckDuckGo":e.match(/OPX/i)?"Opera GX":navigator.brave?"Brave":l.default.getParser(navigator.userAgent).getBrowserName(),t}const M=b()?"algorand://":"algorand-wc://";function D(e){return{ROOT:`https://${e}`,CONNECT:`https://${e}/connect`,TRANSACTION_SIGN:`https://${e}/transaction/sign`}}function R(e=!0){let t=M;const n=W();return e&&n&&(t=`${t}?browser=${encodeURIComponent(n)}`),t}function x(e){const t=new URL(e);return t.searchParams.append("embedded","true"),t.toString()}function B({isWebWalletAvailable:e,shouldDisplayNewBadge:t,shouldUseSound:n}){return{open:(a={isWebWalletAvailable:e,shouldDisplayNewBadge:t,shouldUseSound:n},e=>{if(!document.getElementById("pera-wallet-connect-modal-wrapper")){const t=w("pera-wallet-connect-modal-wrapper"),n=`${e}&algorand=true`,{isWebWalletAvailable:o,shouldDisplayNewBadge:r,shouldUseSound:l}=a;t.innerHTML=`<pera-wallet-connect-modal uri="${n}" is-web-wallet-avaliable="${o}" should-display-new-badge="${r}" should-use-sound="${l}"></pera-wallet-connect-modal>`}}),close:()=>h("pera-wallet-connect-modal-wrapper")};var a}"undefined"!=typeof window&&(window.global=window,window.Buffer=window.Buffer||require("buffer").Buffer,Promise.resolve().then((function(){return require("./App-23ae7ba0.js")}))),exports.PERA_DOWNLOAD_URL="https://perawallet.app/download/",exports.PERA_WALLET_CONNECT_MODAL_ID="pera-wallet-connect-modal-wrapper",exports.PERA_WALLET_MODAL_CLASSNAME="pera-wallet-modal",exports.PERA_WALLET_REDIRECT_MODAL_ID="pera-wallet-redirect-modal-wrapper",exports.PERA_WALLET_SIGN_TXN_MODAL_ID="pera-wallet-sign-txn-modal-wrapper",exports.PERA_WALLET_SIGN_TXN_TOAST_ID="pera-wallet-sign-txn-toast-wrapper",exports.PeraWalletConnect=class{constructor(e){this.bridge=(null==e?void 0:e.bridge)||"",this.connector=null,this.shouldShowSignTxnToast=void 0===(null==e?void 0:e.shouldShowSignTxnToast)||e.shouldShowSignTxnToast,this.chainId=null==e?void 0:e.chainId}get platform(){return function(){const e=f();let t=null;return"pera-wallet"===(null==e?void 0:e.type)?t="mobile":"pera-wallet-web"===(null==e?void 0:e.type)&&(t="web"),t}()}get isConnected(){var e;return"mobile"===this.platform?!!this.connector:"web"===this.platform&&!!(null===(e=f())||void 0===e?void 0:e.accounts.length)}connectWithWebWallet(e,t,n,a){const o=W(),r=D(n),l=document.createElement("iframe");function s(){h("pera-wallet-connect-modal-wrapper")}return{onWebWalletConnect:function(n){if("Chrome"===o){if(l.setAttribute("id","pera-wallet-iframe"),l.setAttribute("src",x(r.CONNECT)),n.appendChild(l),l.contentWindow){let n=0;const o=setInterval((()=>{n+=1,50!==n?d.sendMessage({message:{type:"IFRAME_INITIALIZED"},origin:r.CONNECT,targetWindow:l.contentWindow}):clearInterval(o)}),700);d.setupListener({onReceiveMessage:n=>{var u,w,g,m,h,v;if("IFRAME_INITIALIZED_RECEIVED"===n.data.message.type)clearInterval(o),d.sendMessage({message:{type:"CONNECT",data:Object.assign(Object.assign({},c()),{chainId:a})},origin:r.CONNECT,targetWindow:l.contentWindow});else if(e&&"CONNECT_CALLBACK"===n.data.message.type){const t=n.data.message.data.addresses;C(t,"pera-wallet-web"),e(t),s(),null===(u=document.getElementById("pera-wallet-iframe"))||void 0===u||u.remove()}else if("CONNECT_NETWORK_MISMATCH"===n.data.message.type)t(new i({type:"CONNECT_NETWORK_MISMATCH",detail:n.data.message.error},n.data.message.error||"Your wallet is connected to a different network to this dApp. Update your wallet to the correct network (MainNet or TestNet) to continue.")),s(),null===(w=document.getElementById("pera-wallet-iframe"))||void 0===w||w.remove();else if(["CREATE_PASSCODE_EMBEDDED","SELECT_ACCOUNT_EMBEDDED"].includes(n.data.message.type))if("CREATE_PASSCODE_EMBEDDED"===n.data.message.type)p(r.CONNECT).then((n=>{n&&d.sendMessage({message:{type:"CONNECT",data:Object.assign(Object.assign({},c()),{chainId:a})},origin:r.CONNECT,targetWindow:n});const o=setInterval((()=>{!0===(null==n?void 0:n.closed)&&(t(new i({type:"CONNECT_CANCELLED"},"Connect is cancelled by user")),s(),clearInterval(o))}),2e3);d.setupListener({onReceiveMessage:t=>{if(e&&"CONNECT_CALLBACK"===t.data.message.type){const a=t.data.message.data.addresses;C(a,"pera-wallet-web"),e(a),s(),null==n||n.close()}}})}));else if("SELECT_ACCOUNT_EMBEDDED"===n.data.message.type){const e=document.getElementById("pera-wallet-connect-modal-wrapper"),t=null===(m=null===(g=null==e?void 0:e.querySelector("pera-wallet-connect-modal"))||void 0===g?void 0:g.shadowRoot)||void 0===m?void 0:m.querySelector(".pera-wallet-modal"),n=null===(v=null===(h=null==t?void 0:t.querySelector("pera-wallet-modal-desktop-mode"))||void 0===h?void 0:h.shadowRoot)||void 0===v?void 0:v.querySelector(".pera-wallet-connect-modal-desktop-mode");t&&n&&(t.classList.add("pera-wallet-modal--select-account"),t.classList.remove("pera-wallet-modal--create-passcode"),n.classList.add("pera-wallet-connect-modal-desktop-mode--select-account"),n.classList.remove("pera-wallet-connect-modal-desktop-mode--create-passcode")),d.sendMessage({message:{type:"SELECT_ACCOUNT_EMBEDDED_CALLBACK"},origin:r.CONNECT,targetWindow:l.contentWindow})}}})}}else p(r.CONNECT).then((n=>{n&&d.sendMessage({message:{type:"CONNECT",data:Object.assign(Object.assign({},c()),{chainId:a})},origin:r.CONNECT,targetWindow:n});const o=setInterval((()=>{!0===(null==n?void 0:n.closed)&&(t(new i({type:"CONNECT_CANCELLED"},"Connect is cancelled by user")),clearInterval(o),s())}),2e3);d.setupListener({onReceiveMessage:a=>{if(e&&"CONNECT_CALLBACK"===a.data.message.type){const t=a.data.message.data.addresses;C(t,"pera-wallet-web"),e(t),s(),null==n||n.close()}else"CONNECT_NETWORK_MISMATCH"===a.data.message.type&&(t(new i({type:"CONNECT_NETWORK_MISMATCH",detail:a.data.message.error},a.data.message.error||"Your wallet is connected to a different network to this dApp. Update your wallet to the correct network (MainNet or TestNet) to continue.")),s(),null==n||n.close())}})})).catch((e=>{s(),t(e)}))}}}connect(){return new Promise(((e,t)=>s(this,void 0,void 0,(function*(){var n;try{if(null===(n=this.connector)||void 0===n?void 0:n.connected)try{yield this.connector.killSession()}catch(e){}const{isWebWalletAvailable:a,bridgeURL:r,webWalletURL:l,shouldDisplayNewBadge:s,shouldUseSound:d}=yield I(),{onWebWalletConnect:c}=this.connectWithWebWallet(e,t,l,this.chainId);a&&(window.onWebWalletConnect=c),this.connector=new o.default({bridge:this.bridge||r||"https://bridge.walletconnect.org",qrcodeModal:B({isWebWalletAvailable:a,shouldDisplayNewBadge:s,shouldUseSound:d})}),yield this.connector.createSession({chainId:this.chainId||4160}),function(e){var t,n,a,o;const r=document.getElementById("pera-wallet-connect-modal-wrapper"),l=null===(n=null===(t=null==r?void 0:r.querySelector("pera-wallet-connect-modal"))||void 0===t?void 0:t.shadowRoot)||void 0===n?void 0:n.querySelector(".pera-wallet-modal"),s=null===(o=null===(a=null==l?void 0:l.querySelector("pera-wallet-modal-header"))||void 0===a?void 0:a.shadowRoot)||void 0===o?void 0:o.getElementById("pera-wallet-modal-header-close-button");null==s||s.addEventListener("click",(()=>{e(),h("pera-wallet-connect-modal-wrapper")}))}((()=>t(new i({type:"CONNECT_MODAL_CLOSED"},"Connect modal is closed by user")))),this.connector.on("connect",((n,a)=>{var o,r;n&&t(n),e((null===(o=this.connector)||void 0===o?void 0:o.accounts)||[]),C((null===(r=this.connector)||void 0===r?void 0:r.accounts)||[])}))}catch(e){console.log(e),t(new i({type:"SESSION_CONNECT",detail:e},e.message||"There was an error while connecting to Pera Wallet"))}}))))}reconnectSession(){return new Promise(((e,t)=>s(this,void 0,void 0,(function*(){var n,a;try{const r=f();if("pera-wallet-web"===(null==r?void 0:r.type)){const{isWebWalletAvailable:n}=yield I();n?e(r.accounts||[]):t(new i({type:"SESSION_RECONNECT",detail:"Pera Web is not available"},"Pera Web is not available"))}this.connector&&e(this.connector.accounts||[]),this.bridge=(null===(n=function(){var e;const t=null===(e=E())||void 0===e?void 0:e.getItem(N);return t?JSON.parse(t):null}())||void 0===n?void 0:n.bridge)||"",this.bridge&&(this.connector=new o.default({bridge:this.bridge}),e((null===(a=this.connector)||void 0===a?void 0:a.accounts)||[])),this.isConnected||e([])}catch(e){yield this.disconnect(),t(new i({type:"SESSION_RECONNECT",detail:e},e.message||"There was an error while reconnecting to Pera Wallet"))}}))))}disconnect(){var e;return s(this,void 0,void 0,(function*(){let t;this.isConnected&&"mobile"===this.platform&&(t=null===(e=this.connector)||void 0===e?void 0:e.killSession(),null==t||t.then((()=>{this.connector=null}))),yield T()}))}signTransactionWithMobile(e){return s(this,void 0,void 0,(function*(){const t=(n="algo_signTxn",a=[e],{id:Date.now()*Math.pow(10,3)+Math.floor(Math.random()*Math.pow(10,3)),jsonrpc:"2.0",method:n,params:a});var n,a;try{try{const{silent:e}=yield I(),n=(yield this.connector.sendCustomRequest(t,{forcePushNotification:!e})).filter(Boolean);return"string"==typeof n[0]?n.map(A):n.map((e=>Uint8Array.from(e)))}catch(e){return yield Promise.reject(new i({type:"SIGN_TRANSACTIONS",detail:e},e.message||"Failed to sign transaction"))}}finally{h("pera-wallet-redirect-modal-wrapper"),h("pera-wallet-sign-txn-toast-wrapper")}}))}signTransactionWithWeb(e,t){return new Promise(((n,a)=>{const o=D(t);"Chrome"===W()?g().then((t=>{var r,l,s,c;const u=t,p=document.createElement("iframe"),w=x(o.TRANSACTION_SIGN),g=`hid ${w}; bluetooth ${w}`;p.setAttribute("id","pera-wallet-iframe"),p.setAttribute("src",w),p.setAttribute("allow",g),null==u||u.appendChild(p);const v=null===(s=null===(l=null===(r=document.getElementById("pera-wallet-sign-txn-modal-wrapper"))||void 0===r?void 0:r.querySelector("pera-wallet-sign-txn-modal"))||void 0===l?void 0:l.shadowRoot)||void 0===s?void 0:s.querySelector("pera-wallet-modal-header"),N=null===(c=null==v?void 0:v.shadowRoot)||void 0===c?void 0:c.getElementById("pera-wallet-modal-header-close-button");if(N&&N.addEventListener("click",(()=>{a(new i({type:"SIGN_TXN_CANCELLED"},"Transaction signing is cancelled by user.")),h("pera-wallet-sign-txn-modal-wrapper")})),p.contentWindow){let t=0;const r=setInterval((()=>{t+=1,50!==t?d.sendMessage({message:{type:"IFRAME_INITIALIZED"},origin:o.CONNECT,targetWindow:p.contentWindow}):clearInterval(r)}),700);d.setupListener({onReceiveMessage:t=>{var l,s,c;"IFRAME_INITIALIZED_RECEIVED"===t.data.message.type&&(clearInterval(r),d.sendMessage({message:{type:"SIGN_TXN",txn:e},origin:x(o.TRANSACTION_SIGN),targetWindow:p.contentWindow})),"SIGN_TXN_CALLBACK"===t.data.message.type&&(null===(l=document.getElementById("pera-wallet-iframe"))||void 0===l||l.remove(),m(),n(t.data.message.signedTxns.map((e=>A(e.signedTxn))))),"SIGN_TXN_NETWORK_MISMATCH"===t.data.message.type&&a(new i({type:"SIGN_TXN_NETWORK_MISMATCH",detail:t.data.message.error},t.data.message.error||"Network mismatch")),"SESSION_DISCONNECTED"===t.data.message.type&&(null===(s=document.getElementById("pera-wallet-iframe"))||void 0===s||s.remove(),m(),T(),a(new i({type:"SESSION_DISCONNECTED",detail:t.data.message.error},t.data.message.error))),"SIGN_TXN_CALLBACK_ERROR"===t.data.message.type&&(null===(c=document.getElementById("pera-wallet-iframe"))||void 0===c||c.remove(),m(),a(new i({type:"SIGN_TXN_CANCELLED"},t.data.message.error)))}})}})).catch((e=>{console.log(e)})):p(o.TRANSACTION_SIGN).then((t=>{t&&d.sendMessage({message:{type:"SIGN_TXN",txn:e},origin:o.TRANSACTION_SIGN,targetWindow:t});const r=setInterval((()=>{!0===(null==t?void 0:t.closed)&&(a(new i({type:"SIGN_TXN_CANCELLED"},"Transaction signing is cancelled by user.")),clearInterval(r))}),2e3);d.setupListener({onReceiveMessage:e=>{"SIGN_TXN_CALLBACK"===e.data.message.type&&(null==t||t.close(),n(e.data.message.signedTxns.map((e=>A(e.signedTxn))))),"SIGN_TXN_NETWORK_MISMATCH"===e.data.message.type&&a(new i({type:"SIGN_TXN_NETWORK_MISMATCH",detail:e.data.message.error},e.data.message.error||"Network mismatch")),"SESSION_DISCONNECTED"===e.data.message.type&&(null==t||t.close(),T(),a(new i({type:"SESSION_DISCONNECTED",detail:e.data.message.error},e.data.message.error))),"SIGN_TXN_CALLBACK_ERROR"===e.data.message.type&&(null==t||t.close(),a(new i({type:"SIGN_TXN_CANCELLED"},e.data.message.error)))}})})).catch((e=>{a(e)}))}))}signTransaction(e,t){return s(this,void 0,void 0,(function*(){if("mobile"===this.platform&&(L()?w("pera-wallet-redirect-modal-wrapper").innerHTML="<pera-wallet-redirect-modal></pera-wallet-redirect-modal>":!L()&&this.shouldShowSignTxnToast&&(w("pera-wallet-sign-txn-toast-wrapper").innerHTML="<pera-wallet-sign-txn-toast></pera-wallet-sign-txn-toast>"),!this.connector))throw new Error("PeraWalletConnect was not initialized correctly.");const n=e.flatMap((e=>e.map((e=>function(e,t){let n;t&&!(e.signers||[]).includes(t)&&(n=[]);const a={txn:(o=e.txn,Buffer.from(r.default.encodeUnsignedTransaction(o)).toString("base64"))};var o;return Array.isArray(n)&&(a.signers=n),e.authAddr&&(a.authAddr=e.authAddr),e.message&&(a.message=e.message),e.msig&&(a.msig=e.msig),a}(e,t)))));if("web"===this.platform){const{webWalletURL:e}=yield I();return this.signTransactionWithWeb(n,e)}return this.signTransactionWithMobile(n)}))}},exports.closePeraWalletSignTxnToast=function(){h("pera-wallet-sign-txn-toast-wrapper")},exports.detectBrowser=W,exports.generatePeraWalletAppDeepLink=R,exports.generatePeraWalletConnectDeepLink=function(e){let t=R(!1);O()&&!t.includes("-wc")&&(t=t.replace("://","-wc://"));let n=`${t}wc?uri=${encodeURIComponent(e)}`;const a=W();return b()&&(n=e),a&&(n=`${n}&browser=${encodeURIComponent(a)}`),n},exports.isIOS=O,exports.isMobile=L,exports.removeModalWrapperFromDOM=h;
